# STOMP Policies

This subdirectory contains *policies* to be used by STOMP during various simulations.  A policy in STOMP is generated by writing a small amount of Python code to fill out the contents of a base class *BaseSchedulingPolicy*.
This base class contains only three main routines:
 * init
 * assign_task_to_server
 * remove_task_from_server


## The 'init' Routine

The 'init' routine is largely boilerplate and mostly ensures that the policy class has copies of the servers, stomp_stats and stomp_params data for the current simulation run.  In most cases this routine will have the form as below:
```
    def init(self, servers, stomp_stats, stomp_params):
        self.stomp_stats  = stomp_stats
        self.stomp_params = stomp_params
        self.servers      = servers
        self.n_servers    = len(servers)
```
If the scheduling policy also required additional state or initialization, that could also be placed in the init routine.

### Inputs to 'init'
The inputs to the init routine are
 * the servers present in the current STOMP simulation
 * the statistics tracked by STOMP
 * the parameters to the current STOMP run

## The 'assign_task_to_server' Routine

The 'assign_task_to_server' routine is used to determine which server should be assigned the next task to be assigned.  This is the primary focus of the scheduler policy analysis at this time, and this STOMP distribution contains several example policies to help prospective policy writers to understand how one might make such a decision.  Note that the 'assign_task_to_server' has access to the servers of the current STOMP simulation (see the 'class Server' in stomp.py) and the set of tasks (see 'class Task' in the stomp.py code) and thus can make use of the members of those classes to determine to which server (from among the 'servers') the current task (which is at 'tasks[0]') should be scheduled.


### Inputs to 'assign_task_to_server'
The inputs to the 'assign_task_to_server' routine are:
 * The current simulation time
 * The current list of to-be-scheduled tasks

*Note:*
At this time, STOMP always schedules the first task in the waiting tasks list.  Support for scheduling tasks out of arrival order is a current TO-DO.


## The 'remove_task_from_server' Routine

The 'remove_task_from_server' routine is invoked when a task is retired from the simulation, and is primarily intended to allow the policy to clean up whatever internal data or state is necessary on task retirement.  The current example policies do not yet require any action at task retirement time, and so their 'remove_task_from_server' routine is as below:

```
   def remove_task_from_server(self, sim_time, server):
        pass
```

### Inputs to 'remove_task_from_server'
The inputs (arguments) to the 'remove_task_from_server' routine are:
 * the current simulation time
 * the server from which the task is being removed/finishing/retiring

## USAGE

The general invocation is quite conventional; this script shoul dbe invoked from the "stomp" directory level, as:
```
./utils/run_all.py
```

## OPTIONS

The run_all.py script supports both command-line options, and script-modification options.

### Command Line Options
 
 * -h or --help : This outputs the usage information 
 * -s or --save-stdout  : This saves the output of each STOMP run into the file.
 * -p or --pre-gen-tasks : This instructs STOMP to pre-generate the task information (at the start of the run).  This results in a consistent set of tasks across the runs; it is effectively a "dynamically-generated" trace.
 * -a or --arrival-trace : This will cause the first run of a STOMP simulation to generate a trace, which will then be used as an arrival trace by every succeeding STOMP simulation run.  This guarantees that the task arrival time and task_types are consisten across all the STOMP simulations and provides an exact trace of that first simulation (which can be used in future simulations, etc.).  Note that the trace is used as an "arrival" trace and not an "input" trace because the run_all.py script alters (scales) the standard deviations across runs, and the input trace fixes the task service times (which the arrival trace does not).

### In-Script Options

The run_all.py script specifies the baseline configuration file, and the set of scheduling policies and standard deviation factors to use in the parametric sweep in a few lines near the top of the file (just after the includes):
```
CONF_FILE    = './stomp.json'
POLICY       = ['simple_policy_ver1', 'simple_policy_ver2', 'simple_policy_ver3']
STDEV_FACTOR = [0.01, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]  # percentages
```

Altering these values, e.g. by adding or removing entries from the STDEV_FACTOR list, will cause the run_all.py script to run a modified parametric sweep, but will still generate all the same data, etc. 
__NOTE that altering the POLICY list also requires the addition of new policy files in the policies subdirectory of stomp (by the same name)__

## OUTPUTS

The results of the run are put into an automtically generated directory names sim_<date>_<time>.
This directory will hold a numb er of files:
 * avg_resp_time.out  : This has a summary of the average response time across all the SOTMP simulations
 * queue_size_hist.out : This holds information about the queue size during the run, including some histogram information
 * policy:simple_policy_ver1__stdev_factor:0.01.decoder.simple_policy_ver1.trace : There will be a number of such files, named similarly to this; the name is policy:<policy_name>__stdev_factor:<value>.<task_type>.<policy_name>.trace and it holds a record of all the tasks of type <task_type> simulated during the run.  This file provides information about each task, including origination time, service time, etc. 

## Requirements

STOMP requires:
 * Python 2.7


## Contributors

Augusto Vega (IBM) --  ajvega@us.ibm.com
J-D Wellman (IBM) -- wellman@us.ibm.com

## Current Maintainers

Augusto Vega (IBM) --  ajvega@us.ibm.com
J-D Wellman (IBM) -- wellman@us.ibm.com
